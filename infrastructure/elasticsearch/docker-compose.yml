# Local development ES + Logstash stack
#
# Prerequisites:
#   - Kafka running on the same Docker network (infrastructure/kafka/docker-compose.yml)
#   - Topics created: normalized-messages, processing-results, alerts
#
# Usage:
#   cd infrastructure/elasticsearch
#   docker compose up -d
#
# Access:
#   - Elasticsearch API: http://localhost:9200
#   - Logstash monitoring API: http://localhost:9600

version: '3.8'

services:
  elasticsearch:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: umbrella-elasticsearch
    environment:
      ES_JAVA_OPTS: -Xms512m -Xmx512m
      discovery.type: single-node
      cluster.name: umbrella
      xpack.security.enabled: 'false'
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
      - elasticsearch-logs:/usr/share/elasticsearch/logs
    healthcheck:
      test: curl -s http://localhost:9200/_cluster/health?local=true | grep -q '"status":"yellow"'
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 30s
    networks:
      - umbrella

  es-init:
    image: alpine/curl:latest
    container_name: umbrella-es-init
    depends_on:
      elasticsearch:
        condition: service_healthy
    entrypoint:
      - /bin/sh
      - -c
      - |
        echo "Loading Elasticsearch templates and ILM policy..."

        curl -X PUT "http://elasticsearch:9200/_ilm/policy/umbrella-retention" \
          -H "Content-Type: application/json" \
          -d '{
            "policy": "umbrella-retention",
            "phases": {
              "hot": {
                "min_age": "0d",
                "actions": {}
              },
              "warm": {
                "min_age": "30d",
                "actions": {
                  "set_priority": {
                    "priority": 50
                  },
                  "forcemerge": {
                    "max_num_segments": 1
                  }
                }
              },
              "cold": {
                "min_age": "90d",
                "actions": {
                  "set_priority": {
                    "priority": 0
                  }
                }
              },
              "delete": {
                "min_age": "2555d",
                "actions": {
                  "delete": {}
                }
              }
            }
          }'

        echo ""
        echo "Loading messages index template..."
        curl -X PUT "http://elasticsearch:9200/_index_template/messages-template" \
          -H "Content-Type: application/json" \
          -d '{"template":{"settings":{"number_of_shards":1,"number_of_replicas":0,"index.lifecycle.name":"umbrella-retention","index.lifecycle.rollover_alias":"messages"},"mappings":{"properties":{"message_id":{"type":"keyword"},"channel":{"type":"keyword"},"direction":{"type":"keyword"},"timestamp":{"type":"date"},"participants":{"type":"nested","properties":{"id":{"type":"keyword"},"name":{"type":"text","fields":{"keyword":{"type":"keyword"}}},"role":{"type":"keyword"}}},"body_text":{"type":"text","analyzer":"standard"},"audio_ref":{"type":"keyword"},"attachments":{"type":"nested","properties":{"name":{"type":"text","fields":{"keyword":{"type":"keyword"}}},"content_type":{"type":"keyword"},"s3_uri":{"type":"keyword"}}},"metadata":{"type":"object","enabled":true},"transcript":{"type":"text","analyzer":"standard"},"language":{"type":"keyword"},"translated_text":{"type":"text","analyzer":"standard"},"entities":{"type":"nested","properties":{"text":{"type":"text","fields":{"keyword":{"type":"keyword"}}},"label":{"type":"keyword"},"start":{"type":"integer"},"end":{"type":"integer"}}},"sentiment":{"type":"keyword"},"sentiment_score":{"type":"float"},"risk_score":{"type":"float"},"matched_policies":{"type":"keyword"},"processing_status":{"type":"keyword"}}},"composed_of":[],"priority":100,"_meta":{"description":"Index template for normalized messages with enrichments"}}}'

        echo ""
        echo "Loading alerts index template..."
        curl -X PUT "http://elasticsearch:9200/_index_template/alerts-template" \
          -H "Content-Type: application/json" \
          -d '{"template":{"settings":{"number_of_shards":1,"number_of_replicas":0,"index.lifecycle.name":"umbrella-retention","index.lifecycle.rollover_alias":"alerts"},"mappings":{"properties":{"alert_id":{"type":"keyword"},"message_id":{"type":"keyword"},"channel":{"type":"keyword"},"timestamp":{"type":"date"},"alert_type":{"type":"keyword"},"severity":{"type":"keyword"},"risk_score":{"type":"float"},"matched_policies":{"type":"keyword"},"matched_terms":{"type":"keyword"},"excerpt":{"type":"text"},"participants":{"type":"nested","properties":{"id":{"type":"keyword"},"name":{"type":"text","fields":{"keyword":{"type":"keyword"}}},"role":{"type":"keyword"}}},"review_status":{"type":"keyword"},"reviewer":{"type":"keyword"},"reviewed_at":{"type":"date"},"disposition":{"type":"keyword"},"notes":{"type":"text"}}},"composed_of":[],"priority":100,"_meta":{"description":"Index template for compliance alerts"}}}'

        echo ""
        echo "Templates and ILM policy loaded successfully!"
    networks:
      - umbrella

  logstash:
    build:
      context: .
      dockerfile: infrastructure/logstash/Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
    container_name: umbrella-logstash
    depends_on:
      - elasticsearch
    environment:
      LS_JAVA_OPTS: -Xms512m -Xmx512m
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    ports:
      - "9600:9600"
    volumes:
      - ./infrastructure/logstash/pipeline:/usr/share/logstash/pipeline
      - ./infrastructure/logstash/config:/usr/share/logstash/config
    healthcheck:
      test: curl -s http://localhost:9600/ > /dev/null
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 60s
    networks:
      - umbrella

volumes:
  elasticsearch-data:
  elasticsearch-logs:

networks:
  umbrella:
    external: true
