apiVersion: batch/v1
kind: Job
metadata:
  name: elasticsearch-init-templates
  namespace: umbrella-storage
  labels:
    app: elasticsearch
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: elasticsearch-init
    spec:
      serviceAccountName: default
      restartPolicy: Never
      containers:
        - name: init-templates
          image: curlimages/curl:latest
          env:
            - name: ELASTICSEARCH_HOST
              value: "http://elasticsearch.umbrella-storage.svc:9200"
          command:
            - /bin/sh
            - -c
            - |
              set -e

              echo "Waiting for Elasticsearch to be healthy..."
              until curl -s -f "${ELASTICSEARCH_HOST}/_cluster/health?wait_for_status=yellow" > /dev/null; do
                echo "Elasticsearch not ready, waiting..."
                sleep 5
              done

              echo "Elasticsearch is healthy. Loading templates..."

              # Load ILM policy
              echo "Loading ILM policy..."
              curl -X PUT "${ELASTICSEARCH_HOST}/_ilm/policy/umbrella-retention" \
                -H "Content-Type: application/json" \
                -d '{
                  "policy": "umbrella-retention",
                  "phases": {
                    "hot": {
                      "min_age": "0d",
                      "actions": {}
                    },
                    "warm": {
                      "min_age": "30d",
                      "actions": {
                        "set_priority": {"priority": 50},
                        "forcemerge": {"max_num_segments": 1}
                      }
                    },
                    "cold": {
                      "min_age": "90d",
                      "actions": {
                        "set_priority": {"priority": 0},
                        "searchable_snapshot": {"snapshot_repository": "found-snapshots"}
                      }
                    },
                    "delete": {
                      "min_age": "2555d",
                      "actions": {"delete": {}}
                    }
                  }
                }'
              echo ""

              # Load messages index template
              echo "Loading messages index template..."
              curl -X PUT "${ELASTICSEARCH_HOST}/_index_template/messages-template" \
                -H "Content-Type: application/json" \
                -d '{"template":{"settings":{"number_of_shards":1,"number_of_replicas":0,"index.lifecycle.name":"umbrella-retention","index.lifecycle.rollover_alias":"messages"},"mappings":{"properties":{"message_id":{"type":"keyword"},"channel":{"type":"keyword"},"direction":{"type":"keyword"},"timestamp":{"type":"date"},"participants":{"type":"nested","properties":{"id":{"type":"keyword"},"name":{"type":"text","fields":{"keyword":{"type":"keyword"}}},"role":{"type":"keyword"}}},"body_text":{"type":"text","analyzer":"standard"},"audio_ref":{"type":"keyword"},"attachments":{"type":"nested","properties":{"name":{"type":"text","fields":{"keyword":{"type":"keyword"}}},"content_type":{"type":"keyword"},"s3_uri":{"type":"keyword"}}},"metadata":{"type":"object","enabled":true},"transcript":{"type":"text","analyzer":"standard"},"language":{"type":"keyword"},"translated_text":{"type":"text","analyzer":"standard"},"entities":{"type":"nested","properties":{"text":{"type":"text","fields":{"keyword":{"type":"keyword"}}},"label":{"type":"keyword"},"start":{"type":"integer"},"end":{"type":"integer"}}},"sentiment":{"type":"keyword"},"sentiment_score":{"type":"float"},"risk_score":{"type":"float"},"matched_policies":{"type":"keyword"},"processing_status":{"type":"keyword"}}},"composed_of":[],"priority":100,"_meta":{"description":"Index template for normalized messages with enrichments"}}}'
              echo ""

              # Load alerts index template
              echo "Loading alerts index template..."
              curl -X PUT "${ELASTICSEARCH_HOST}/_index_template/alerts-template" \
                -H "Content-Type: application/json" \
                -d '{"template":{"settings":{"number_of_shards":1,"number_of_replicas":0,"index.lifecycle.name":"umbrella-retention","index.lifecycle.rollover_alias":"alerts"},"mappings":{"properties":{"alert_id":{"type":"keyword"},"message_id":{"type":"keyword"},"channel":{"type":"keyword"},"timestamp":{"type":"date"},"alert_type":{"type":"keyword"},"severity":{"type":"keyword"},"risk_score":{"type":"float"},"matched_policies":{"type":"keyword"},"matched_terms":{"type":"keyword"},"excerpt":{"type":"text"},"participants":{"type":"nested","properties":{"id":{"type":"keyword"},"name":{"type":"text","fields":{"keyword":{"type":"keyword"}}},"role":{"type":"keyword"}}},"review_status":{"type":"keyword"},"reviewer":{"type":"keyword"},"reviewed_at":{"type":"date"},"disposition":{"type":"keyword"},"notes":{"type":"text"}}},"composed_of":[],"priority":100,"_meta":{"description":"Index template for compliance alerts"}}}'
              echo ""

              echo "Templates and ILM policy loaded successfully!"
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
